<div class="mission-detail-container selection:bg-accent selection:text-white">
  <div class="bg-mesh"></div>
  <div class="tech-grid"></div>

  <div class="max-w-7xl mx-auto px-6 py-20 animate-shuttle pb-32 relative z-10">
    @if (loading) {
      <div class="h-[60vh] flex flex-col items-center justify-center opacity-40">
        <div
          class="w-12 h-12 rounded-xl border-2 border-accent border-t-transparent animate-spin mb-6"
        ></div>
        <p class="text-[10px] font-black uppercase tracking-[0.5em] text-accent animate-pulse">
          Synchronizing Activity System...
        </p>
      </div>
    } @else if (isCountdownActive) {
      <div class="fixed inset-0 bg-black z-[2000] flex items-center justify-center overflow-hidden">
        <div class="bg-mesh opacity-50"></div>
        <div class="text-center relative z-10">
          <div
            class="text-accent text-[12px] font-black uppercase tracking-[0.6em] mb-12 animate-shuttle"
          >
            Room starting soon
          </div>
          <div
            class="text-[24rem] font-black text-white leading-none tracking-[-0.08em] animate-shuttle italic"
          >
            {{ countdownValue }}
          </div>
          <div class="mt-12 flex justify-center gap-4 opacity-40">
            <div
              class="w-2 h-2 bg-accent rounded-full animate-bounce"
              style="animation-delay: 0s"
            ></div>
            <div
              class="w-2 h-2 bg-accent rounded-full animate-bounce"
              style="animation-delay: 0.1s"
            ></div>
            <div
              class="w-2 h-2 bg-accent rounded-full animate-bounce"
              style="animation-delay: 0.2s"
            ></div>
          </div>
        </div>
      </div>
    } @else if (mission) {
      <!-- Mission Elite Header -->
      <header class="mb-16 flex flex-col lg:flex-row lg:items-end justify-between gap-12">
        <div class="flex-grow">
          <div class="flex items-center gap-3 mb-8">
            <span class="glass-pill !bg-accent/10 !text-accent !border-accent/20">{{
              mission.category || 'Hangout Room'
            }}</span>
            <span
              [class]="
                'glass-pill !border-none px-4 ' +
                (mission.status === 'Open'
                  ? '!bg-v-text-primary !text-v-bg-base'
                  : '!bg-v-glass !text-v-text-muted')
              "
            >
              {{ mission.status }}
            </span>
          </div>
          <h1
            class="text-5xl md:text-8xl font-black uppercase tracking-tight leading-[0.85] mb-8 italic"
          >
            {{ mission.name }}
          </h1>
          <div class="flex flex-col gap-4">
            <p
              class="text-v-text-muted font-medium tracking-wide uppercase text-[11px] max-w-2xl leading-relaxed italic border-l-2 border-accent/30 pl-6"
            >
              {{
                mission.description ||
                  'Welcome to the hangout space. Join the group and start sharing vibes with other community members.'
              }}
            </p>
          </div>
        </div>

        <div class="flex flex-wrap gap-4 mb-2 lg:justify-end">
          @if (mission.location) {
            <div
              class="glass-pill flex items-center gap-3 bg-v-glass !border-v-border hover:bg-v-glass-hover transition-colors"
            >
              <i class="pi pi-map-marker text-accent text-[12px]"></i>
              <span class="text-[11px] font-bold tracking-widest text-v-text-muted uppercase">{{
                mission.location
              }}</span>
            </div>
          }
          @if (mission.scheduled_at) {
            <div
              class="glass-pill flex items-center gap-3 bg-v-glass !border-v-border hover:bg-v-glass-hover transition-colors"
            >
              <i class="pi pi-clock text-accent text-[12px]"></i>
              <span class="text-[11px] font-bold tracking-widest text-v-text-muted uppercase"
                >{{ mission.scheduled_at | date: 'HH:mm' }} UTC</span
              >
            </div>
          }
          <div class="glass-pill flex items-center gap-3 bg-accent/20 !border-accent/30">
            <div class="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></div>
            <span class="text-[11px] font-black tracking-widest text-accent uppercase"
              >Active Room</span
            >
          </div>
        </div>
      </header>

      <!-- Tactical Room Grid -->
      <div class="grid grid-cols-12 gap-8 lg:h-[780px] animate-shuttle">
        <!-- Left: Crew Roster -->
        <aside
          class="col-span-12 lg:col-span-3 shuttle-card flex flex-col !p-0 overflow-hidden group"
        >
          <div class="tech-scanline"></div>
          <div class="p-8 border-b border-v-border bg-v-bg-subtle">
            <h3
              class="text-[11px] font-black uppercase tracking-[0.3em] flex justify-between items-center text-v-text-muted"
            >
              Member List
              <span
                class="text-accent bg-accent/10 px-3 py-1 rounded-lg border border-accent/20 font-black tracking-tight text-[12px]"
              >
                {{ mission.crew_count }}/{{ mission.max_crew }}
              </span>
            </h3>
          </div>

          <div class="flex-grow overflow-y-auto p-8 space-y-8 custom-scrollbar">
            <!-- Chief Section -->
            <div>
              <div
                class="section-label !text-[9px] !font-black !uppercase !tracking-[0.2em] !text-v-text-muted mb-5"
              >
                Room Host
              </div>
              <div
                class="flex items-center gap-4 p-5 rounded-2xl bg-accent/5 border border-accent/10 relative overflow-hidden group/chief cursor-pointer transition-all hover:bg-accent/10"
                [routerLink]="['/profile', mission.chief_id]"
              >
                <div class="absolute inset-0 bg-gradient-to-br from-accent/5 to-transparent"></div>
                <img
                  [src]="
                    mission.chief_avatar_url ||
                    'https://api.dicebear.com/7.x/bottts-neutral/svg?seed=' +
                      mission.chief_display_name
                  "
                  class="w-12 h-12 rounded-xl border border-accent/20 relative z-10 object-cover"
                />
                <div class="flex-grow relative z-10">
                  <div
                    class="text-[13px] font-black uppercase tracking-tight text-v-text-primary m-0 leading-none group-hover/chief:text-accent transition-colors"
                  >
                    {{ mission.chief_display_name }}
                  </div>
                  <div
                    class="text-[9px] font-black uppercase tracking-widest text-accent mt-1.5 opacity-60"
                  >
                    Host
                  </div>
                </div>
              </div>
            </div>

            <!-- Crew Section -->
            <div>
              <div
                class="section-label !text-[9px] !font-black !uppercase !tracking-[0.2em] !text-v-text-muted mb-5"
              >
                Active Members
              </div>
              <div class="flex flex-col gap-3">
                @for (member of crew; track member.id) {
                  @if (member.id !== mission.chief_id) {
                    <div
                      class="flex items-center gap-4 p-4 rounded-xl hover:bg-white/[0.03] border border-transparent hover:border-white/5 transition-all group/member cursor-pointer"
                      [routerLink]="['/profile', member.id]"
                    >
                      <img
                        [src]="
                          member.avatar_url ||
                          'https://api.dicebear.com/7.x/bottts-neutral/svg?seed=' +
                            member.display_name
                        "
                        class="w-10 h-10 rounded-lg border border-v-border opacity-60 group-hover/member:opacity-100 transition-opacity"
                      />
                      <div class="flex-grow">
                        <div
                          class="text-[12px] font-bold uppercase tracking-tight text-v-text-muted group-hover/member:text-v-text-primary transition-colors"
                        >
                          {{ member.display_name }}
                        </div>
                      </div>
                      @if (isChief && mission.status === 'Open') {
                        <button
                          pButton
                          icon="pi pi-user-minus"
                          (click)="onKick(member); $event.stopPropagation()"
                          class="p-button-text p-button-danger !p-0 !w-8 !h-8 opacity-0 group-hover/member:opacity-100 transition-all hover:scale-110"
                          title="Remove Member"
                        ></button>
                      }
                    </div>
                  }
                } @empty {
                  <div class="py-16 text-center opacity-20 flex flex-col items-center gap-4">
                    <i class="pi pi-users text-4xl mb-2"></i>
                    <p class="italic text-[10px] font-black uppercase tracking-[0.25em]">
                      Waiting for more people
                    </p>
                  </div>
                }
              </div>
            </div>
          </div>
        </aside>

        <!-- Center: Discussion Chat -->
        <main
          class="col-span-12 lg:col-span-6 shuttle-card !p-0 flex flex-col overflow-hidden relative"
        >
          <div
            class="Tech-Overlay absolute inset-0 bg-[radial-gradient(circle_at_50%_0%,rgba(113,78,255,0.05)_0%,transparent_70%)] pointer-events-none"
          ></div>

          <div
            class="p-8 border-b border-v-border flex justify-between items-center bg-v-glass relative z-10"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-1.5 h-1.5 rounded-full bg-accent shadow-[0_0_10px_var(--accent-glow)]"
              ></div>
              <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-v-text-muted">
                Discussion / Public
              </h3>
            </div>
            @if (isChief && comments.length > 0) {
              <button
                pButton
                icon="pi pi-refresh"
                label="CLEAR CHAT"
                (click)="clearChat()"
                class="p-button-text p-button-danger !text-[9px] !font-black !h-9 !px-5 !rounded-lg border border-red-500/10 hover:bg-red-500/10"
              ></button>
            }
          </div>

          <div
            class="flex-grow overflow-y-auto p-10 flex flex-col gap-10 custom-scrollbar relative z-10"
            #chatMessages
          >
            @for (comment of comments; track comment.id) {
              <div
                class="flex gap-4 group animate-shuttle"
                [class.flex-row-reverse]="comment.brawler_id === currentUserId"
              >
                <img
                  [src]="
                    comment.brawler_avatar_url ||
                    'https://api.dicebear.com/7.x/bottts-neutral/svg?seed=' +
                      comment.brawler_display_name
                  "
                  class="w-11 h-11 rounded-xl mt-1 object-cover border border-white/10 group-hover:border-accent/30 transition-colors cursor-pointer"
                  [routerLink]="['/profile', comment.brawler_id]"
                />
                <div
                  class="flex flex-col gap-2.5 max-w-[85%]"
                  [class.items-end]="comment.brawler_id === currentUserId"
                >
                  <div
                    class="flex items-center gap-4 text-[9px] font-black uppercase tracking-widest text-v-text-muted"
                  >
                    <span
                      class="text-v-text-secondary group-hover:text-accent transition-colors cursor-pointer"
                      [routerLink]="['/profile', comment.brawler_id]"
                      >{{ comment.brawler_display_name }}</span
                    >
                    <span class="opacity-40">{{ comment.created_at | date: 'HH:mm:ss' }}</span>
                  </div>
                  <div
                    class="chat-bubble-elite"
                    [class.sent]="comment.brawler_id === currentUserId"
                    [class.received]="comment.brawler_id !== currentUserId"
                  >
                    {{ comment.content }}
                  </div>
                </div>
              </div>
            } @empty {
              <div
                class="h-full flex flex-col items-center justify-center text-center px-10 opacity-30"
              >
                <div
                  class="w-24 h-24 rounded-3xl border border-white/10 flex items-center justify-center mb-8 bg-white/5 relative"
                >
                  <div
                    class="absolute inset-0 rounded-3xl border border-accent/20 neural-pulse"
                  ></div>
                  <i class="pi pi-lock text-v-text-muted text-3xl"></i>
                </div>
                <h3 class="text-2xl font-black uppercase tracking-widest mb-4 italic">
                  Room Discussion
                </h3>
                <p
                  class="text-[10px] font-black uppercase tracking-[0.4em] text-v-text-muted max-w-xs leading-loose"
                >
                  Connected to room chat. Type a message below to start hanging out.
                </p>
              </div>
            }
          </div>

          <div
            class="p-8 border-t border-v-border flex items-center gap-4 bg-v-glass relative z-10"
          >
            <div class="flex-grow relative group">
              <input
                type="text"
                class="w-full h-16 bg-v-glass rounded-2xl px-8 text-[14px] border border-v-border group-hover:bg-v-glass-hover focus:border-accent/50 outline-none transition-all placeholder:text-v-text-muted text-v-text-primary font-medium"
                [(ngModel)]="newCommentContent"
                (keyup.enter)="sendComment()"
                [disabled]="sendingComment || isMissionDeleted || isKicked"
                [placeholder]="
                  isMissionDeleted || isKicked ? '// SYSTEM_OFFLINE...' : 'SHARE YOUR VIBE...'
                "
              />
            </div>
            <button
              pButton
              icon="pi pi-bolt"
              (click)="sendComment()"
              [disabled]="sendingComment || !newCommentContent.trim()"
              class="w-16 h-16 p-button-primary !rounded-2xl !shadow-none hover:scale-105 active:scale-95 transition-transform"
            ></button>
          </div>
        </main>

        <!-- Right: Command Center -->
        <aside class="col-span-12 lg:col-span-3 flex flex-col gap-8">
          <div class="shuttle-card !p-0 overflow-hidden relative">
            <div class="p-8 border-b border-v-border bg-v-bg-subtle">
              <h3 class="text-[11px] font-black uppercase tracking-[0.3em] text-v-text-muted">
                Room Controls
              </h3>
            </div>

            <div class="p-8 space-y-8 relative z-10">
              <div
                class="p-8 rounded-3xl bg-v-glass border border-v-border relative group/integrity"
              >
                <div class="absolute top-4 right-4 animate-pulse">
                  <div
                    class="w-1.5 h-1.5 rounded-full bg-accent shadow-[0_0_8px_var(--accent-glow)]"
                  ></div>
                </div>
                <div
                  class="text-[10px] font-black uppercase tracking-[0.3em] text-v-text-muted mb-6 group-hover/integrity:text-accent transition-colors"
                >
                  Room Capacity
                </div>
                <div class="flex flex-col gap-4">
                  <div class="flex items-end justify-between">
                    <span class="text-5xl font-black italic tracking-tighter text-v-text-primary">
                      {{
                        mission.crew_count >= mission.max_crew
                          ? '100'
                          : ((mission.crew_count / mission.max_crew) * 100).toFixed(0)
                      }}%
                    </span>
                    <i class="pi pi-shield text-accent/40 text-2xl"></i>
                  </div>
                  <div class="w-full h-1.5 bg-v-border rounded-full overflow-hidden">
                    <div
                      class="h-full bg-primary-gradient transition-all duration-1000"
                      [style.width.%]="(mission.crew_count / mission.max_crew) * 100"
                    ></div>
                  </div>
                </div>
              </div>

              @if (isChief) {
                <div class="pt-8 border-t border-white/5 space-y-4">
                  <label
                    class="text-[9px] font-black uppercase tracking-[0.4em] text-v-text-muted px-2 block mb-4"
                    >Activity Controls</label
                  >

                  @if (mission.status === 'Open') {
                    <button
                      pButton
                      label="START ACTIVITY"
                      icon="pi pi-power-off"
                      [disabled]="mission.crew_count === 0"
                      (click)="onStart()"
                      class="w-full h-16 p-button-primary !text-[11px] !font-black !tracking-[0.2em] !rounded-2xl hover:scale-[1.02] active:scale-[0.98] transition-transform"
                    ></button>
                  } @else if (mission.status === 'InProgress') {
                    <button
                      pButton
                      label="COMPLETE ACTIVITY"
                      icon="pi pi-check-circle"
                      (click)="onComplete()"
                      class="w-full h-15 !bg-green-500/10 !text-green-500 !border-green-500/20 !text-[11px] !font-black !tracking-[0.2em] !rounded-2xl hover:!bg-green-500 hover:!text-white transition-all mb-3"
                    ></button>
                    <button
                      pButton
                      label="CANCEL ACTIVITY"
                      icon="pi pi-times-circle"
                      (click)="onFail()"
                      class="w-full h-15 !bg-red-500/10 !text-red-500 !border-red-500/20 !text-[11px] !font-black !tracking-[0.2em] !rounded-2xl hover:!bg-red-500 hover:!text-white transition-all"
                    ></button>
                  } @else {
                    <div
                      class="p-10 text-center bg-v-bg-subtle rounded-3xl border border-v-border border-dashed"
                    >
                      <i class="pi pi-box text-3xl text-v-text-muted mb-4 block"></i>
                      <div
                        class="text-[10px] font-black uppercase tracking-[0.4em] text-v-text-muted"
                      >
                        Archive Status
                      </div>
                      <div class="text-[12px] font-bold text-v-text-primary mt-2 uppercase">
                        Activity Closed
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div
                  class="p-10 text-center bg-accent/5 rounded-3xl border border-accent/10 border-dashed group/await"
                >
                  <i class="pi pi-spin pi-spinner text-3xl text-accent/40 mb-6 block"></i>
                  <p
                    class="text-[10px] font-black uppercase tracking-[0.3em] text-v-text-muted leading-loose"
                  >
                    Waiting for the host to start.
                  </p>
                </div>
              }

              @if (isMissionDeleted || isKicked) {
                <button
                  pButton
                  label="LEAVE_ROOM"
                  icon="pi pi-sign-out"
                  (click)="leaveMission()"
                  class="w-full h-15 !bg-red-500/10 !text-red-500 !border-red-500/20 !text-[11px] !font-black !tracking-[0.2em] !rounded-2xl hover:!bg-red-500 hover:!text-white transition-all shadow-[0_0_20px_rgba(239,68,68,0.1)]"
                ></button>
              }
            </div>
          </div>

          <div class="shuttle-card !p-8 bg-accent/5 !border-accent/20 relative group/protocol">
            <div
              class="absolute inset-0 bg-[radial-gradient(circle_at_100%_100%,rgba(255,78,171,0.05)_0%,transparent_50%)]"
            ></div>
            <h4
              class="text-[10px] font-black uppercase tracking-[0.4em] text-accent/60 mb-5 relative z-10 flex items-center gap-3"
            >
              <i class="pi pi-lock"></i> Room Encryption
            </h4>
            <p class="text-[11px] text-v-text-muted leading-relaxed font-bold italic relative z-10">
              All messages in this room are end-to-end encrypted and kept secure within the Vibe
              network. Your privacy is our priority.
            </p>
          </div>
        </aside>
      </div>
    }
  </div>
</div>
