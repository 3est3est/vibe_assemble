<div class="mission-room-container">
  @if (loading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Synchronizing mission protocol...</p>
    </div>
  } @else if (isCountdownActive) {
    <div class="countdown-overlay">
      <div class="box">
        <div class="prepare">PREPARING DEPARTURE</div>
        <div class="timer">{{ countdownValue }}</div>
      </div>
    </div>
  } @else if (mission) {
    <header class="page-header">
      <div class="info">
        <h1>{{ mission.name }}</h1>
        <p class="desc">{{ mission.description }}</p>
        <div class="logistics">
          @if (mission.scheduled_at) {
            <div class="item">
              <mat-icon>schedule</mat-icon>
              <span>{{ mission.scheduled_at | date: 'MMM d, h:mm a' }}</span>
            </div>
          }
          @if (mission.location) {
            <div class="item">
              <mat-icon>place</mat-icon>
              <span>{{ mission.location }}</span>
            </div>
          }
        </div>
      </div>
      <div class="badges">
        @if (mission.category) {
          <div class="category-badge">
            {{ mission.category }}
          </div>
        }
        <div [class]="'status-badge ' + mission.status.toLowerCase()">
          {{ mission.status }}
        </div>
      </div>
    </header>

    <div class="room-grid">
      <!-- Left: Crew Panel -->
      <aside class="panel">
        <div class="panel-header">
          <h3>Crew ({{ mission.crew_count }}/{{ mission.max_crew }})</h3>
        </div>
        <div class="crew-list">
          <div class="member-card active-user" [class.chief]="mission.chief_id === currentUserId">
            <a [routerLink]="['/profile', mission.chief_id]">
              <img
                [src]="
                  mission.chief_avatar_url ||
                  'https://ui-avatars.com/api/?name=' +
                    mission.chief_display_name +
                    '&background=random&size=64'
                "
                class="avatar"
              />
            </a>
            <div class="info">
              <span class="name">
                <a [routerLink]="['/profile', mission.chief_id]">{{
                  mission.chief_display_name
                }}</a>
              </span>
              <span class="role">Chief Officer</span>
            </div>
          </div>

          @for (member of crew; track member.id) {
            @if (member.id !== mission.chief_id) {
              <div class="member-card" [class.active-user]="member.id === currentUserId">
                <a [routerLink]="['/profile', member.id]">
                  <img
                    [src]="
                      member.avatar_url ||
                      'https://ui-avatars.com/api/?name=' +
                        member.display_name +
                        '&background=random&size=64'
                    "
                    class="avatar"
                  />
                </a>
                <div class="info">
                  <span class="name">
                    <a [routerLink]="['/profile', member.id]">{{ member.display_name }}</a>
                  </span>
                  <span class="role">Mission Crew</span>
                </div>
                @if (isChief && mission.status === 'Open') {
                  <button class="kick-btn" (click)="onKick(member)">
                    <mat-icon size="small">remove_circle</mat-icon>
                  </button>
                }
              </div>
            }
          }
        </div>
      </aside>

      <!-- Center: Chat Panel -->
      <main class="panel chat-panel">
        <div class="panel-header">
          <h3>Mission Briefing</h3>
          @if (isChief && comments.length > 0) {
            <button class="icon-btn-danger" (click)="clearChat()" title="Clear History">
              <mat-icon>delete</mat-icon>
              <span>Clear</span>
            </button>
          }
        </div>

        <div class="messages" #chatMessages>
          @for (comment of comments; track comment.id) {
            <div class="message" [class.own]="comment.brawler_id === currentUserId">
              <a [routerLink]="['/profile', comment.brawler_id]">
                <img
                  [src]="
                    comment.brawler_avatar_url ||
                    'https://ui-avatars.com/api/?name=' +
                      comment.brawler_display_name +
                      '&background=random&size=64'
                  "
                  class="msg-avatar"
                />
              </a>
              <div class="bubble">
                <div class="header">
                  <span class="author">
                    <a [routerLink]="['/profile', comment.brawler_id]">{{
                      comment.brawler_display_name
                    }}</a>
                  </span>
                  <span class="time">{{ comment.created_at | date: 'h:mm a' }}</span>
                </div>
                <div class="text">{{ comment.content }}</div>
              </div>
            </div>
          } @empty {
            <div class="empty-chat">Room established. Stand by for orders.</div>
          }
        </div>

        <div class="input-area" [class.disabled]="isMissionDeleted || isKicked">
          <input
            type="text"
            [placeholder]="
              isMissionDeleted || isKicked ? 'Broadcast offline' : 'Send message to crew...'
            "
            [(ngModel)]="newCommentContent"
            (keyup.enter)="sendComment()"
            [disabled]="sendingComment || isMissionDeleted || isKicked"
          />
          <button (click)="sendComment()" [disabled]="sendingComment || !newCommentContent.trim()">
            <mat-icon>{{ sendingComment ? 'sync' : 'send' }}</mat-icon>
          </button>
        </div>
      </main>

      <!-- Right: Command Panel -->
      <aside class="panel command-panel">
        <div class="panel-header">
          <h3>Command Center</h3>
        </div>
        <div class="actions">
          @if (isChief) {
            @if (mission.status === 'Open') {
              <button
                class="btn-action start"
                [disabled]="mission.crew_count === 0"
                (click)="onStart()"
              >
                <mat-icon>play_circle</mat-icon> Execute Mission
              </button>
            } @else if (mission.status === 'InProgress') {
              <button class="btn-action complete" (click)="onComplete()">
                <mat-icon>verified</mat-icon> Mark Success
              </button>
              <button class="btn-action fail" (click)="onFail()">
                <mat-icon>error</mat-icon> Report Failure
              </button>
            } @else {
              <p class="final-status">Operation Finalized</p>
            }
          } @else {
            <div class="crew-brief">
              <p>Stand by for Chief's command. Maintain communication.</p>
            </div>
          }

          @if (isMissionDeleted || isKicked) {
            <button class="btn-action fail" (click)="leaveMission()">
              <mat-icon>logout</mat-icon> Exit Room
            </button>
          }
        </div>
      </aside>
    </div>
  }
</div>
