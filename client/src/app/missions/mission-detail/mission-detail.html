<div class="relative min-h-screen bg-black selection:bg-white selection:text-black">
  <div class="bg-mesh"></div>

  <div class="max-w-7xl mx-auto px-6 py-20 animate-shuttle pb-32">
    @if (loading) {
      <div class="h-[60vh] flex flex-col items-center justify-center opacity-40">
        <i class="pi pi-spin pi-spinner text-4xl mb-6"></i>
        <p class="text-[10px] font-black uppercase tracking-[0.4em]">
          Synchronizing Mission Protocol...
        </p>
      </div>
    } @else if (isCountdownActive) {
      <div class="fixed inset-0 bg-black z-[2000] flex items-center justify-center overflow-hidden">
        <div class="bg-mesh opacity-50"></div>
        <div class="text-center relative z-10">
          <div
            class="text-zinc-500 text-[12px] font-bold uppercase tracking-[0.5em] mb-12 animate-shuttle"
          >
            Departure Imminent
          </div>
          <div
            class="text-[24rem] font-black text-white leading-none tracking-[-0.08em] animate-shuttle"
          >
            {{ countdownValue }}
          </div>
          <div class="mt-12 flex justify-center gap-2 opacity-20">
            <div class="w-1 h-1 bg-white rounded-full"></div>
            <div class="w-1 h-1 bg-white rounded-full"></div>
            <div class="w-1 h-1 bg-white rounded-full"></div>
          </div>
        </div>
      </div>
    } @else if (mission) {
      <!-- Mission Shuttle Header -->
      <header class="mb-16 flex flex-col md:flex-row md:items-end justify-between gap-12">
        <div class="flex-grow">
          <div class="flex items-center gap-3 mb-8">
            <div class="glass-pill opacity-60">{{ mission.category || 'Standard Op' }}</div>
            <div
              [class]="
                'glass-pill border-none px-4 ' +
                (mission.status === 'Open' ? 'bg-white text-black' : 'bg-zinc-800 text-zinc-400')
              "
            >
              {{ mission.status }}
            </div>
          </div>
          <h1 class="text-7xl font-black uppercase tracking-[-0.05em] leading-[0.85] mb-8">
            {{ mission.name }}
          </h1>
          <p
            class="text-zinc-500 font-medium tracking-wide uppercase text-[10px] max-w-2xl leading-relaxed"
          >
            {{
              mission.description || 'Secure intelligence frequency. Mission briefing initiated.'
            }}
          </p>
        </div>

        <div class="flex gap-4 mb-2">
          @if (mission.location) {
            <div class="glass-pill flex items-center gap-3 bg-zinc-900/40 border-zinc-800/50">
              <i class="pi pi-map-marker text-zinc-600 text-[10px]"></i>
              <span class="text-[10px] font-bold tracking-widest text-zinc-400">{{
                mission.location
              }}</span>
            </div>
          }
          @if (mission.scheduled_at) {
            <div class="glass-pill flex items-center gap-3 bg-zinc-900/40 border-zinc-800/50">
              <i class="pi pi-clock text-zinc-600 text-[10px]"></i>
              <span class="text-[10px] font-bold tracking-widest text-zinc-400">{{
                mission.scheduled_at | date: 'HH:mm'
              }}</span>
            </div>
          }
        </div>
      </header>

      <!-- Tactical Room Grid -->
      <div class="grid grid-cols-12 gap-8 h-[750px] animate-shuttle">
        <!-- Left: Crew Roster -->
        <aside class="col-span-12 lg:col-span-3 shuttle-card flex flex-col !p-8 overflow-hidden">
          <h3
            class="text-[10px] font-black uppercase tracking-[0.2em] mb-10 flex justify-between items-center text-zinc-600"
          >
            Crew Roster
            <span class="text-zinc-400 font-bold tracking-normal"
              >{{ mission.crew_count }}/{{ mission.max_crew }}</span
            >
          </h3>

          <div class="flex-grow overflow-y-auto space-y-6 pr-2 custom-scrollbar">
            <!-- Chief Section -->
            <div
              class="section-label text-[8px] font-black uppercase tracking-widest text-zinc-700 mb-3"
            >
              Commanding Officer
            </div>
            <div
              class="flex items-center gap-4 p-4 rounded-2xl bg-zinc-400/5 border border-zinc-800/50"
            >
              <img
                [src]="
                  mission.chief_avatar_url ||
                  'https://ui-avatars.com/api/?name=' +
                    mission.chief_display_name +
                    '&background=18181b&color=fff'
                "
                class="w-10 h-10 rounded-lg"
              />
              <div class="flex-grow">
                <div class="text-[11px] font-black uppercase tracking-tight text-white">
                  {{ mission.chief_display_name }}
                </div>
                <div class="text-[8px] font-bold uppercase tracking-widest text-zinc-500">
                  Chief Officer
                </div>
              </div>
            </div>

            <!-- Crew Section -->
            <div
              class="section-label text-[8px] font-black uppercase tracking-widest text-zinc-700 mt-10 mb-3"
            >
              Deployed Operatives
            </div>
            <div class="flex flex-col gap-2">
              @for (member of crew; track member.id) {
                @if (member.id !== mission.chief_id) {
                  <div
                    class="flex items-center gap-4 p-3 rounded-xl hover:bg-zinc-800/40 transition-all group"
                  >
                    <img
                      [src]="
                        member.avatar_url ||
                        'https://ui-avatars.com/api/?name=' +
                          member.display_name +
                          '&background=18181b&color=fff'
                      "
                      class="w-9 h-9 rounded-lg border border-zinc-800"
                    />
                    <div class="flex-grow">
                      <div
                        class="text-[11px] font-black uppercase tracking-tight text-zinc-400 group-hover:text-white transition-colors"
                      >
                        {{ member.display_name }}
                      </div>
                    </div>
                    @if (isChief && mission.status === 'Open') {
                      <button
                        pButton
                        icon="pi pi-minus-circle"
                        (click)="onKick(member)"
                        class="p-button-text p-button-danger p-0 w-8 h-8 opacity-0 group-hover:opacity-100 transition-all"
                      ></button>
                    }
                  </div>
                }
              } @empty {
                <div
                  class="py-12 text-center opacity-20 italic text-[10px] font-bold uppercase tracking-[0.2em] text-zinc-600"
                >
                  Awaiting deployment.
                </div>
              }
            </div>
          </div>
        </aside>

        <!-- Center: Tactical Comms -->
        <main class="col-span-12 lg:col-span-6 shuttle-card !p-0 flex flex-col overflow-hidden">
          <div
            class="p-8 border-b border-zinc-800/50 flex justify-between items-center bg-zinc-900/20"
          >
            <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-600">
              Briefing Channel
            </h3>
            @if (isChief && comments.length > 0) {
              <button
                pButton
                icon="pi pi-trash"
                label="CLEAR FREQUENCY"
                (click)="clearChat()"
                class="p-button-text p-button-danger text-[9px] font-black h-8 px-4"
              ></button>
            }
          </div>

          <div
            class="flex-grow overflow-y-auto p-12 flex flex-col gap-12 custom-scrollbar"
            #chatMessages
          >
            @for (comment of comments; track comment.id) {
              <div
                class="flex gap-8 group"
                [class.flex-row-reverse]="comment.brawler_id === currentUserId"
              >
                <img
                  [src]="
                    comment.brawler_avatar_url ||
                    'https://ui-avatars.com/api/?name=' +
                      comment.brawler_display_name +
                      '&background=18181b&color=fff'
                  "
                  class="w-10 h-10 rounded-lg mt-1 object-cover"
                />
                <div
                  class="flex flex-col gap-3 max-w-[80%]"
                  [class.items-end]="comment.brawler_id === currentUserId"
                >
                  <div
                    class="flex items-center gap-4 text-[9px] font-black uppercase tracking-widest text-zinc-700"
                  >
                    <span class="text-zinc-500">{{ comment.brawler_display_name }}</span>
                    <span>{{ comment.created_at | date: 'HH:mm' }}</span>
                  </div>
                  <div
                    class="p-5 rounded-2xl text-[14px] leading-relaxed font-medium"
                    [class]="
                      comment.brawler_id === currentUserId
                        ? 'bg-white text-black rounded-tr-none'
                        : 'bg-zinc-400/5 text-zinc-300 border border-zinc-800/50 rounded-tl-none'
                    "
                  >
                    {{ comment.content }}
                  </div>
                </div>
              </div>
            } @empty {
              <div class="h-full flex flex-col items-center justify-center text-center px-10">
                <div
                  class="w-20 h-20 rounded-full border border-zinc-800 flex items-center justify-center mb-10 bg-zinc-900/50"
                >
                  <i class="pi pi-lock text-zinc-700 text-2xl"></i>
                </div>
                <h3 class="text-2xl font-black uppercase tracking-tight mb-4">Channel Secured</h3>
                <p
                  class="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-600 max-w-xs leading-loose"
                >
                  Encrypted frequency established. Transmit signal to initiate room records.
                </p>
              </div>
            }
          </div>

          <div class="p-8 border-t border-zinc-800/50 flex items-center gap-4 bg-zinc-900/40">
            <input
              type="text"
              class="flex-grow h-14 bg-zinc-900/50 rounded-2xl px-6 text-[14px] border border-zinc-800/50 focus:border-zinc-500 focus:bg-zinc-900 outline-none transition-all placeholder:text-zinc-700"
              [(ngModel)]="newCommentContent"
              (keyup.enter)="sendComment()"
              [disabled]="sendingComment || isMissionDeleted || isKicked"
              [placeholder]="
                isMissionDeleted || isKicked ? 'Broadcast offline...' : 'Send secure transmit...'
              "
            />
            <button
              pButton
              icon="pi pi-send"
              (click)="sendComment()"
              [disabled]="sendingComment || !newCommentContent.trim()"
              class="w-14 h-14 p-button-primary rounded-xl"
            ></button>
          </div>
        </main>

        <!-- Right: Command Center -->
        <aside class="col-span-12 lg:col-span-3 flex flex-col gap-8">
          <div class="shuttle-card !p-8">
            <h3 class="text-[10px] font-black uppercase tracking-[0.2em] mb-10 text-zinc-600">
              Command Center
            </h3>

            <div class="space-y-8">
              <div class="p-8 rounded-3xl bg-zinc-400/5 border border-zinc-800/50">
                <div class="text-[9px] font-black uppercase tracking-widest text-zinc-700 mb-6">
                  Mission Integrity
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-3xl font-black italic"
                    >{{
                      mission.crew_count >= mission.max_crew
                        ? '100'
                        : ((mission.crew_count / mission.max_crew) * 100).toFixed(0)
                    }}%</span
                  >
                  <i class="pi pi-verified text-white text-xl"></i>
                </div>
              </div>

              @if (isChief) {
                <div class="pt-8 border-t border-zinc-800/50 space-y-4">
                  <label
                    class="text-[8px] font-black uppercase tracking-widest text-zinc-700 px-2 block"
                    >Operational Controls</label
                  >
                  @if (mission.status === 'Open') {
                    <button
                      pButton
                      label="INITIALIZE EXECUTION"
                      icon="pi pi-play"
                      [disabled]="mission.crew_count === 0"
                      (click)="onStart()"
                      class="w-full h-14 p-button-primary text-[10px] font-black tracking-widest"
                    ></button>
                  } @else if (mission.status === 'InProgress') {
                    <button
                      pButton
                      label="MARK SUCCESS"
                      icon="pi pi-check"
                      (click)="onComplete()"
                      class="w-full h-14 p-button-success text-[10px] font-black"
                    ></button>
                    <button
                      pButton
                      label="REPORT FAILURE"
                      icon="pi pi-times"
                      (click)="onFail()"
                      class="w-full h-14 p-button-danger p-button-outlined border-zinc-800 text-[10px] font-black"
                    ></button>
                  } @else {
                    <div
                      class="p-8 text-center bg-zinc-900/50 rounded-3xl border border-zinc-800/50"
                    >
                      <div class="text-[10px] font-black uppercase tracking-widest text-zinc-600">
                        Operation Closed
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="p-8 text-center bg-zinc-900/50 rounded-3xl border border-zinc-800/50">
                  <i class="pi pi-shield text-3xl text-zinc-800 mb-6 block"></i>
                  <p
                    class="text-[9px] font-black uppercase tracking-widest text-zinc-600 leading-loose"
                  >
                    Awaiting command authorization from Chief Officer.
                  </p>
                </div>
              }

              @if (isMissionDeleted || isKicked) {
                <button
                  pButton
                  label="ABORT ROOM"
                  icon="pi pi-sign-out"
                  (click)="leaveMission()"
                  class="w-full h-14 p-button-danger p-button-outlined border-red-500/20 text-[10px] font-black"
                ></button>
              }
            </div>
          </div>

          <div class="shuttle-card !p-8 bg-black/40 border-dashed">
            <h4 class="text-[9px] font-black uppercase tracking-widest text-zinc-700 mb-4">
              Security Protocol
            </h4>
            <p class="text-[10px] text-zinc-600 leading-relaxed font-medium">
              All transmissions in this sector are end-to-end encrypted and logged to the
              decentralized authority.
            </p>
          </div>
        </aside>
      </div>
    }
  </div>
</div>
