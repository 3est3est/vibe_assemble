<header class="page-header">
  <h1>Explore</h1>
  <p>Find and join activities in the community.</p>
</header>

<div class="discovery-controls">
  <div class="search-row">
    <div class="search-input" id="search-input">
      <mat-icon>search</mat-icon>
      <input
        type="text"
        [(ngModel)]="filter.name"
        placeholder="Search activities..."
        (keyup.enter)="onSubmit()"
      />
    </div>
  </div>

  <div class="filters-row" id="filters-area">
    <select class="status-select" [(ngModel)]="filter.status">
      <option value="">All Statuses</option>
      <option value="Open">Open</option>
      <option value="InProgress">In Progress</option>
      <option value="Completed">Completed</option>
      <option value="Failed">Cancelled</option>
    </select>

    <select class="category-select" [(ngModel)]="filter.category">
      <option value="">All Categories</option>
      @for (cat of categories; track cat) {
        <option [value]="cat">{{ cat }}</option>
      }
    </select>

    <select class="capacity-select" [(ngModel)]="filter.is_available">
      <option [ngValue]="undefined">All</option>
      <option [ngValue]="true">Available</option>
      <option [ngValue]="false">Full</option>
    </select>

    <button class="filter-btn" (click)="onSubmit()">
      <mat-icon>filter_list</mat-icon>
      Filter
    </button>
  </div>
</div>

<div class="data-table">
  @if ((missions$ | async)?.length) {
    <div class="table-header">
      <span>Activity</span>
      <span>Category</span>
      <span>Description</span>
      <span>Host</span>
      <span>Status</span>
      <span>Members</span>
      <span></span>
    </div>

    @for (mission of missions$ | async; track mission.id) {
      <div class="table-row">
        <div class="mission-info">
          <span class="name">{{ mission.name }}</span>
          <div class="meta">
            @if (mission.scheduled_at) {
              <span
                ><mat-icon>schedule</mat-icon>
                {{ mission.scheduled_at | date: 'MMM d, h:mm a' }}</span
              >
            }
            @if (mission.location) {
              <span><mat-icon>place</mat-icon> {{ mission.location }}</span>
            }
          </div>
        </div>

        <div class="category">
          <span
            [class]="
              'cat-pill ' +
              (mission.category || 'other')
                .toLowerCase()
                .split(' & ')
                .join('-')
                .split(' ')
                .join('-')
            "
            >{{ mission.category || 'Other' }}</span
          >
        </div>

        <div class="description" [title]="mission.description">{{ mission.description }}</div>

        <div class="chief">
          @if (mission.chief_avatar_url) {
            <img [src]="mission.chief_avatar_url" class="chief-circle" alt="Avatar" />
          } @else {
            <img
              [src]="
                'https://ui-avatars.com/api/?name=' +
                mission.chief_display_name +
                '&background=random&size=64'
              "
              class="chief-circle"
              alt="Avatar"
            />
          }
          <span>{{ mission.chief_display_name }}</span>
        </div>

        <div>
          <span [class]="'status-badge ' + mission.status.toLowerCase()">{{
            mission.status === 'Failed' ? 'Cancelled' : mission.status
          }}</span>
        </div>

        <div class="crew-count">{{ mission.crew_count }} / {{ mission.max_crew }}</div>

        <div class="action-cell">
          @if (isSignin()) {
            @if (mission.status === 'Open') {
              <button
                class="action-btn"
                (click)="onJoin(mission)"
                [disabled]="
                  mission.crew_count >= mission.max_crew || joiningMissionId === mission.id
                "
              >
                @if (joiningMissionId === mission.id) {
                  Joining...
                } @else {
                  {{ mission.crew_count >= mission.max_crew ? 'Full' : 'Join' }}
                }
              </button>
            } @else {
              <span class="status-badge">Locked</span>
            }
          }
        </div>
      </div>
    }
  } @else {
    <div class="empty-state">
      <mat-icon>event_busy</mat-icon>
      <p>No activities found matching your criteria.</p>
    </div>
  }
</div>

<app-guide-overlay
  *ngIf="showOnboarding && isSignin()"
  [steps]="onboardingSteps"
  (completed)="onOnboardingComplete()"
>
</app-guide-overlay>
